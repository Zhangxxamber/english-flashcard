<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬é€‰ç»ƒä¹  - å°å­¦è‹±è¯­äºŒå¹´çº§</title>
    
    <!-- å¼•å…¥è¯æ±‡æ•°æ® -->
    <script src="data/vocabulary_book1.js"></script>
    <script src="data/vocabulary_book2.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .title {
            font-size: 2em;
            color: #333;
            font-weight: bold;
        }

        .btn-home {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-home:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .unit-selector select {
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
        }

        /* å¾—åˆ†æ¿ */
        .scoreboard {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            padding: 15px;
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: space-around;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* å‡†å¤‡ç•Œé¢ */
        .ready-screen {
            text-align: center;
        }

        .ready-screen h2 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
        }

        .ready-screen .emoji {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .ready-screen p {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .btn-start {
            padding: 20px 50px;
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .btn-start:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* é¢˜ç›®åŒºåŸŸ */
        .question-area {
            text-align: center;
            width: 100%;
        }

        .question-number {
            font-size: 1.2em;
            color: #999;
            margin-bottom: 20px;
        }

        .speaker-btn {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            font-size: 5em;
            color: white;
            margin: 30px auto;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .speaker-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .speaker-btn:active {
            transform: scale(0.95);
        }

        .hint-text {
            font-size: 1.1em;
            color: #666;
            margin: 20px 0;
        }

        /* é€‰é¡¹åŒºåŸŸ */
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
            width: 100%;
            max-width: 600px;
        }

        .option-btn {
            padding: 25px;
            font-size: 1.3em;
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #333;
        }

        .option-btn:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .option-btn.correct {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: white;
            animation: correctPulse 0.5s;
        }

        .option-btn.wrong {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
            animation: shake 0.5s;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ç»“æœåé¦ˆ */
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct {
            background: rgba(78, 205, 196, 0.2);
            color: #2d6a4f;
        }

        .feedback.wrong {
            background: rgba(255, 107, 107, 0.2);
            color: #c92a2a;
        }

        .correct-answer {
            font-size: 1.5em;
            margin-top: 10px;
        }

        .btn-next {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-next:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        /* å®Œæˆç•Œé¢ */
        .completion-screen {
            text-align: center;
        }

        .completion-screen .emoji {
            font-size: 6em;
            margin-bottom: 20px;
        }

        .completion-screen h2 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 3em;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .score-details {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .btn-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-restart, .btn-back {
            padding: 15px 35px;
            font-size: 1.2em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-restart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-back {
            background: #e9ecef;
            color: #333;
        }

        .btn-restart:hover, .btn-back:hover {
            transform: scale(1.05);
        }

        /* åŠ¨ç”» */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .title {
                font-size: 1.5em;
            }

            .game-area {
                padding: 20px;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .speaker-btn {
                width: 120px;
                height: 120px;
                font-size: 4em;
            }

            .option-btn {
                font-size: 1.1em;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="title-row">
                <div class="title">ğŸ§ å¬é€‰ç»ƒä¹ </div>
                <a href="index.html" class="btn-home">ğŸ  è¿”å›é¦–é¡µ</a>
            </div>
            <div class="controls-row">
                <div class="unit-selector">
                    <select id="unitSelector" onchange="changeUnit()">
                        <option value="all">æ‰€æœ‰å•å…ƒ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å¾—åˆ†æ¿ -->
        <div class="scoreboard">
            <div class="score-item">
                <div class="score-label">å½“å‰é¢˜ç›®</div>
                <div class="score-value" id="currentQuestion">0/0</div>
            </div>
            <div class="score-item">
                <div class="score-label">æ­£ç¡®</div>
                <div class="score-value" id="correctCount">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">æ­£ç¡®ç‡</div>
                <div class="score-value" id="accuracy">0%</div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="game-area" id="gameArea">
            <!-- å‡†å¤‡ç•Œé¢ -->
            <div class="ready-screen" id="readyScreen">
                <div class="emoji">ğŸ¯</div>
                <h2>å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                <p>å¬è‹±æ–‡ï¼Œé€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡æ„æ€</p>
                <button class="btn-start" onclick="startQuiz()">ğŸš€ å¼€å§‹ç»ƒä¹ </button>
            </div>
        </div>
    </div>

    <script>
        // è·å–URLå‚æ•°ä¸­çš„æ•™æç¼–å·
        function getBookNumber() {
            const urlParams = new URLSearchParams(window.location.search);
            const book = urlParams.get('book');
            return book ? parseInt(book) : 1;
        }

        // è·å–å½“å‰æ•™ææ•°æ®
        function getCurrentBookData() {
            const bookNumber = getBookNumber();
            if (bookNumber === 2 && typeof grade2Book2Vocabulary !== 'undefined') {
                document.title = 'å¬é€‰ç»ƒä¹  - äºŒå¹´çº§ä¸‹å†Œ';
                return grade2Book2Vocabulary;
            }
            return grade2Book1Vocabulary;
        }

        // å…¨å±€å˜é‡
        let allData = getCurrentBookData();
        let currentData = [...allData];
        let currentIndex = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let currentQuestion = null;
        let isAnswered = false;

        // åˆå§‹åŒ–å•å…ƒé€‰æ‹©å™¨
        function populateUnitSelector() {
            const unitSelector = document.getElementById('unitSelector');
            const units = {};
            
            allData.forEach(item => {
                if (!units[item.unit]) {
                    units[item.unit] = item.unitName;
                }
            });
            
            let options = '<option value="all">æ‰€æœ‰å•å…ƒ</option>';
            Object.keys(units).forEach(unitKey => {
                const count = allData.filter(item => item.unit === unitKey).length;
                options += `<option value="${unitKey}">${units[unitKey]} (${count}ä¸ª)</option>`;
            });
            
            unitSelector.innerHTML = options;
        }

        // åˆ‡æ¢å•å…ƒ
        function changeUnit() {
            const selector = document.getElementById('unitSelector');
            const selectedUnit = selector.value;
            
            if (selectedUnit === 'all') {
                currentData = [...allData];
            } else {
                currentData = allData.filter(item => item.unit === selectedUnit);
            }
            
            // é‡ç½®æ¸¸æˆ
            resetGame();
        }

        // å¼€å§‹æµ‹éªŒ
        function startQuiz() {
            document.getElementById('readyScreen').style.display = 'none';
            currentIndex = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            shuffleArray(currentData);
            showQuestion();
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            if (currentIndex >= currentData.length) {
                showCompletion();
                return;
            }

            isAnswered = false;
            currentQuestion = currentData[currentIndex];
            totalQuestions++;

            // ç”Ÿæˆé€‰é¡¹
            const options = generateOptions(currentQuestion);
            
            // æ›´æ–°UI
            updateScoreboard();
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="question-area">
                    <div class="question-number">ç¬¬ ${totalQuestions} é¢˜ / å…± ${currentData.length} é¢˜</div>
                    <button class="speaker-btn" onclick="playAudio()">ğŸ”Š</button>
                    <div class="hint-text">ç‚¹å‡»å–‡å­å¬è‹±æ–‡ï¼Œç„¶åé€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡æ„æ€</div>
                    <div class="options" id="optionsArea">
                        ${options.map((opt, index) => 
                            `<button class="option-btn" onclick="selectOption(${index})">${opt}</button>`
                        ).join('')}
                    </div>
                    <div id="feedbackArea"></div>
                </div>
            `;

            // è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡
            setTimeout(() => playAudio(), 500);
        }

        // ç”Ÿæˆé€‰é¡¹ï¼ˆåŒ…æ‹¬æ­£ç¡®ç­”æ¡ˆå’Œ3ä¸ªå¹²æ‰°é¡¹ï¼‰
        function generateOptions(question) {
            const correctAnswer = question.chinese;
            const wrongAnswers = [];
            
            // ä»å…¶ä»–é¢˜ç›®ä¸­éšæœºé€‰æ‹©3ä¸ªä¸åŒçš„ç­”æ¡ˆä½œä¸ºå¹²æ‰°é¡¹
            const otherQuestions = currentData.filter(q => q.chinese !== correctAnswer);
            const shuffled = [...otherQuestions].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 3 && i < shuffled.length; i++) {
                if (!wrongAnswers.includes(shuffled[i].chinese)) {
                    wrongAnswers.push(shuffled[i].chinese);
                }
            }
            
            // å¦‚æœå¹²æ‰°é¡¹ä¸è¶³3ä¸ªï¼Œä»å…¨éƒ¨æ•°æ®ä¸­è¡¥å……
            while (wrongAnswers.length < 3) {
                const randomItem = allData[Math.floor(Math.random() * allData.length)];
                if (randomItem.chinese !== correctAnswer && !wrongAnswers.includes(randomItem.chinese)) {
                    wrongAnswers.push(randomItem.chinese);
                }
            }
            
            // åˆå¹¶å¹¶æ‰“ä¹±é€‰é¡¹
            const options = [correctAnswer, ...wrongAnswers];
            shuffleArray(options);
            return options;
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio() {
            if (!currentQuestion) return;
            
            const utterance = new SpeechSynthesisUtterance(currentQuestion.phrase);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // ç¨æ…¢é€Ÿåº¦ï¼Œé€‚åˆå„¿ç«¥
            speechSynthesis.speak(utterance);
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(index) {
            if (isAnswered) return;
            
            isAnswered = true;
            const buttons = document.querySelectorAll('.option-btn');
            const selectedAnswer = buttons[index].textContent;
            const correctAnswer = currentQuestion.chinese;
            const isCorrect = selectedAnswer === correctAnswer;
            
            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
            buttons.forEach(btn => btn.disabled = true);
            
            // æ ‡è®°é€‰ä¸­çš„ç­”æ¡ˆ
            if (isCorrect) {
                buttons[index].classList.add('correct');
                correctAnswers++;
                showFeedback(true);
            } else {
                buttons[index].classList.add('wrong');
                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                buttons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                showFeedback(false);
            }
            
            updateScoreboard();
        }

        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(isCorrect) {
            const feedbackArea = document.getElementById('feedbackArea');
            const emoji = isCorrect ? 'ğŸ‰' : 'ğŸ’ª';
            const message = isCorrect ? 'å¤ªæ£’äº†ï¼ç­”å¯¹äº†ï¼' : 'åŠ æ²¹ï¼å†æ¥å†å‰ï¼';
            
            feedbackArea.innerHTML = `
                <div class="feedback ${isCorrect ? 'correct' : 'wrong'}">
                    <div>${emoji} ${message}</div>
                    <div class="correct-answer">
                        ${currentQuestion.phrase} = ${currentQuestion.chinese}
                    </div>
                </div>
                <button class="btn-next" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â¡ï¸</button>
            `;
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            currentIndex++;
            showQuestion();
        }

        // æ›´æ–°å¾—åˆ†æ¿
        function updateScoreboard() {
            document.getElementById('currentQuestion').textContent = `${totalQuestions}/${currentData.length}`;
            document.getElementById('correctCount').textContent = correctAnswers;
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // æ˜¾ç¤ºå®Œæˆç•Œé¢
        function showCompletion() {
            const accuracy = Math.round((correctAnswers / totalQuestions) * 100);
            let emoji = 'ğŸ‰';
            let title = 'å¤ªæ£’äº†ï¼';
            
            if (accuracy === 100) {
                emoji = 'ğŸ†';
                title = 'å®Œç¾ï¼æ»¡åˆ†é€šå…³ï¼';
            } else if (accuracy >= 80) {
                emoji = 'ğŸŒŸ';
                title = 'å¾ˆæ£’ï¼ç»§ç»­ä¿æŒï¼';
            } else if (accuracy >= 60) {
                emoji = 'ğŸ‘';
                title = 'ä¸é”™ï¼å†æ¥å†å‰ï¼';
            } else {
                emoji = 'ğŸ’ª';
                title = 'åŠ æ²¹ï¼å¤šå¤šç»ƒä¹ ï¼';
            }
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="completion-screen">
                    <div class="emoji">${emoji}</div>
                    <h2>${title}</h2>
                    <div class="final-score">${accuracy}%</div>
                    <div class="score-details">
                        ç­”å¯¹ ${correctAnswers} é¢˜ï¼Œå…± ${totalQuestions} é¢˜
                    </div>
                    <div class="btn-group">
                        <button class="btn-restart" onclick="startQuiz()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
                        <button class="btn-back" onclick="location.href='index.html'">ğŸ  è¿”å›é¦–é¡µ</button>
                    </div>
                </div>
            `;
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="ready-screen" id="readyScreen">
                    <div class="emoji">ğŸ¯</div>
                    <h2>å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                    <p>å¬è‹±æ–‡ï¼Œé€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡æ„æ€</p>
                    <button class="btn-start" onclick="startQuiz()">ğŸš€ å¼€å§‹ç»ƒä¹ </button>
                </div>
            `;
            currentIndex = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            updateScoreboard();
        }

        // æ•°ç»„éšæœºæ‰“ä¹±
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // åˆå§‹åŒ–
        populateUnitSelector();
        updateScoreboard();
    </script>
</body>
</html>
